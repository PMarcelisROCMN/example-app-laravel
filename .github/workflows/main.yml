on:
  push:
    branches: main
name: ðŸš€ Deploy Laravel project on push
jobs:
  laravel-deploy:
    name: ðŸŽ‰ Deploy Laravel Project
    runs-on: ubuntu-latest
    steps:
      # Step 1: Checkout the latest code from the repository
      - name: ðŸšš Get latest code
        uses: actions/checkout@v4

      # Step 2: Cache Composer dependencies
      - name: ðŸŽ¯ Cache Composer dependencies
        uses: actions/cache@v3
        with:
          path: vendor
          key: composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            composer-

      # Step 3: Set up PHP with Composer
      - name: ðŸ”§ Set up PHP and Composer
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, xml, intl
          coverage: none

      # Step 4: Install Composer dependencies
      - name: ðŸ“¦ Install Composer dependencies
        run: composer install --no-dev --prefer-dist --optimize-autoloader

      # Step 5: Cache Node.js modules
      - name: ðŸŽ¯ Cache Node.js modules
        uses: actions/cache@v3
        with:
          path: node_modules
          key: npm-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            npm-

      # Step 6: Set up Node.js environment
      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 'lts/*'

      # Step 7: Install Node.js dependencies
      - name: ðŸ“¦ Install Node.js dependencies
        run: npm install

      # Step 8: Build frontend assets using Vite
      - name: ðŸ›  Build frontend assets
        run: npm run build

      # Step 9: Upload files to the server using FTP
      - name: ðŸ“‚ Sync files to server
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: klas4s22.mid-ica.nl
          username: ${{ secrets.FTPUSERNAME }}
          password: ${{ secrets.FTPPASSWORD }}
          local-dir: ./
          server-dir: /public_html/
          exclude: |
            vendor/
            node_modules/
            .git/
            .env
            .ftpignore

      # Optional: Clear cache and other necessary Laravel maintenance tasks
      - name: ðŸ§¹ Run Laravel maintenance tasks
        run: |
          php artisan cache:clear
          php artisan config:cache
          php artisan route:cache
          php artisan view:cache
        env:
          APP_ENV: production
